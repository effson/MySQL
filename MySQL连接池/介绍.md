## 1. MySQL 的 连接池（Connection Pool）的作用
### 1.1 减少连接开销
- 每次应用程序访问数据库，如果都要重新建立和释放连接，会产生很大的开销（TCP 三次握手、身份认证、资源分配等）。
- 连接池会预先建立一定数量的连接并放入池中，应用需要时直接复用现有连接，用完再归还，避免频繁创建和销毁

### 1.2 提高并发性能
- 在高并发场景下，如果每个请求都新建连接，数据库和操作系统都可能被拖垮。
- 连接池可以通过最大连接数来控制并发连接的数量，避免数据库被瞬间压垮，同时保证合理的资源利用

### 1.3. 资源复用与管理
连接池会对连接进行统一的生命周期管理，例如：
- 空闲连接保活（避免被数据库服务器回收）。
- 自动回收长时间未使用的连接。
- 健康检查（检测不可用连接并重建）。
- 可以保持连接的长期可用性，减少“死连接”问题
### 1.4 连接池
- 多条连接，MySQL会创建多个线程
- 多个线程并发执行SQL语句


## 2.数据库连接池维持与数据库的连接
### 2.1 维持数据库连接（应用层面）
MySQL 连接是基于 TCP 套接字 的，会话建立后，客户端和 MySQL Server 之间维持一个逻辑连接。
即使应用层没有执行 SQL，这个连接依然存在。
#### 问题：
- 如果长时间没有交互，中间的防火墙 / NAT / 负载均衡设备可能会认为这个连接是“死的”，然后清理掉。
- MySQL 服务端也可能因为空闲超时 (wait_timeout / interactive_timeout) 主动断开
#### 解决方式：
- 定期执行 心跳 SQL（比如 SELECT 1），以确保连接仍然可用
- 借助 TCP keepalive，但更多是主动做 应用层心跳检查
- TCP keepalive主要作用是保证网络畅通，不能确认MySQL是不是正常运行，不能确认MySQL还能不能正常处理任务
- 在没有 SQL 执行时，维持连接更多依赖连接池的心跳策略，定时发送用户态数据包，mysql_ping\mysql_pong

#### 约束
- server发送给MySQL的数据要符合MySQL协议
- server接收到的数据也需要解码，需要安装MySQL驱动
- MySQL驱动需要同时具有编码和解码的能力

#### MySQL驱动
- 官网：C/C++: libmysqlclient.lib /.dll   libmysqlclient.a/.so   mysql.h  阻塞io
- 自己实现，实现mysql协议的编码和解码  workflow\openrestry  非阻塞io


## 3.同步连接池
### 定义
- 传统意义上的数据库连接池，提供的是 阻塞式数据库连接
- 会阻塞线程等待命令完成返回结果
### 工作方式

<img width="272" height="251" alt="image" src="https://github.com/user-attachments/assets/7a7016e1-da39-461c-8272-d36d77a4a87b" />

<br>

```
auto &res = DBImpl->Query("select * from table");    <-----阻塞在此处等待执行结果
...
```
### 工作流程

<img width="784" height="442" alt="image" src="https://github.com/user-attachments/assets/c00eefcb-2d2e-4fbf-b256-dc7d68e21406" />

<br>

- 当前线程从连接池（线程安全）中获取可用连接（未被上锁、锁定的连接），最多允许连接池大小的线程或协程数使用连接
- 应用：服务器启动，初始化资源



## 4.异步连接池
### 定义
提供的是 非阻塞式数据库连接，通常和事件驱动框架（epoll、libuv、async/await）结合

### 工作方式

<img width="272" height="251" alt="image" src="https://github.com/user-attachments/assets/ca3a211a-250a-4c9a-942e-8708c74307ea" />

<br>

```
DBImpl->AsyncQuery(sqlstr, complete_callback);  不会阻塞，继续执行接下来的代码，完成时会调用complete_callback回调函数

void complete_callback(SQLResults &res){
  ...
}

```
### 阻塞io实现异步连接池
另起一个线程等待，不会阻塞当前线程<br>
异步事件等待，例如reactor和proactor，<mark>可参考redis与reactor epoll的结合实现异步处理</mark>

## 5.MySQL的连接驱动与使用
#### 安装libmysqlclient-dev
```bash
apt install libmysqlclient-dev
```
#### 加载mysql.h | 动、静态库

#### 初始化连接驱动mysql_library_init

#### 使用mysql连接驱动与MySQL进行交互
#### 释放连接资源mysql_library_end
